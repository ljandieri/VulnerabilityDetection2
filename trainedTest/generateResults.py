import os

thisDir = os.getcwd()
fileList = os.listdir(thisDir)
resTxtFiles = [f for f in fileList if 'Res.txt' in f]

stats = { el.split('Res')[0] : {} for el in resTxtFiles }

for f in resTxtFiles:
    thisKey = None
    for key in stats.keys():
        if f.split('Res')[0] == key:
            thisKey = key

    with open(f,'r') as openF:
        theseLines = openF.readlines()
        stats[thisKey]['Samples'] = int(theseLines[0].split()[0])
        stats[thisKey]['Vulnerable samples (percentage)'] = theseLines[1].split()[-1]
        stats[thisKey]['Vulnerable samples (total amount)'] = int(theseLines[2].split()[-1])
        stats[thisKey]['Accuracy'] = float(theseLines[3].split()[-1])
        stats[thisKey]['Precision'] = float(theseLines[4].split()[-1])
        stats[thisKey]['Recall'] = float(theseLines[5].split()[-1])
        stats[thisKey]['F1'] = float(theseLines[6].split()[-1])
        stats[thisKey]['Accuracy (%)'] = format(float(theseLines[3].split()[-1]) * 100, '.1f')
        stats[thisKey]['Precision (%)'] = format(float(theseLines[4].split()[-1]) * 100, '.1f')
        stats[thisKey]['Recall (%)'] = format(float(theseLines[5].split()[-1]) * 100, '.1f')
        stats[thisKey]['F1 (%)'] = format(float(theseLines[6].split()[-1]) * 100, '.1f')

l = len(resTxtFiles)
whiteSpace = 24
firstLineStrings = ['VULNERABILITY TYPE','ACCURACY (%)','PRECISION (%)','RECALL (%)','F1 (%)']
firstLine = '|| ' + '|| '.join( [el + ' ' * (whiteSpace - len(el)) for el in firstLineStrings] )
secondLine = '|| ' + '=' * (len(firstLine) - 3)
resultLines = [firstLine,secondLine]
average = {'Precision':0,'Accuracy':0,'Recall':0,'F1':0}

keySequence = ['sql','xss','command_injection','xsfr','remote_code_execution','path_disclosure','open_redirect']
for key in keySequence:
    if key not in stats.keys(): continue
    val = stats[key]
    average['Accuracy'] += float(val['Accuracy (%)'])
    average['Precision'] += float(val['Precision (%)'])
    average['Recall'] += float(val['Recall (%)'])
    average['F1'] += float(val['F1 (%)'])

    thisStrings = [key.replace('_',' '), val['Accuracy (%)'], val['Precision (%)'], val['Recall (%)'], val['F1 (%)']]
    thisLine = '|| '+'|| '.join( [el + ' ' * (whiteSpace - len(el)) for el in thisStrings] )
    resultLines.append(thisLine)

for key,val in average.items():
    average[key] = format(val / l, '.1f')

avgStrings = ['Average',str(average['Accuracy']),str(average['Precision']),str(average['Recall']),str(average['F1'])]
avgLine = '|| ' + '|| '.join( [el + ' ' * (whiteSpace - len(el)) for el in avgStrings] )
resultLines.append(secondLine)
resultLines.append(avgLine)

with open('results.txt','w') as f:
    f.write('\n'.join(resultLines))

